---
// src/components/StrukturOrganisasiSection.astro
---

<section id="pemerintahan-desa" class="organigram-scope">
    
    <div class="organigram-wrapper">
        {/* REVISI: Judul diubah, font size disesuaikan (text-2xl md:text-4xl) tapi gaya tetap */}
        <div class="organigram-header text-2xl md:text-4xl">
            Struktur Organisasi Pemerintahan Desa Sukadana Ilir
        </div>
    
        <div class="tree">
            <ul>
                <li>
                    <div class="card"> 
                        <img src="/Imagery/Aparatur Desa/Kepala Desa.webp" alt="Kepala Desa" class="profile-img" data-name="AGUS SYAHRIWAN - KEPALA DESA">
                        <span class="badge">KEPALA DESA</span>
                        <div class="name">AGUS SYAHRIWAN</div>
                    </div>
    
                    <ul>
                        <li class="branch-long">
                            <ul class="level-offset">
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/KASI PELAYANAN.webp" alt="Kasi Pelayanan" class="profile-img" data-name="HERMAN. S - KASI PELAYANAN">
                                        <span class="badge">KASI PELAYANAN</span>
                                        <div class="name">HERMAN. S</div>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/KASI KESEJAHTERAAN.webp" alt="Kasi Kesejahteraan" class="profile-img" data-name="MUHAMMAD ALWI NASRULLAH - KASI KESEJAHTERAAN">
                                        <span class="badge">KASI KESEJAHTERAAN</span>
                                        <div class="name">MUHAMMAD ALWI NASRULLAH</div>
                                        <span class="gelar">AMd. Kes</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/KASI PEMERINTAHAN.webp" alt="Kasi Pemerintahan" class="profile-img" data-name="MELIANTINA ANDIKA - KASI PEMERINTAHAN">
                                        <span class="badge">KASI PEMERINTAHAN</span>
                                        <div class="name">MELIANTINA ANDIKA</div>
                                    </div>
                                </li>
                            </ul>
                        </li>
    
                        <li>
                            <div class="card">
                                <img src="/Imagery/Aparatur Desa/SEKRETARIS DESA.webp" alt="Sekretaris Desa" class="profile-img" data-name="SUNANTO, S.H - SEKRETARIS DESA">
                                <span class="badge">SEKRETARIS DESA</span>
                                <div class="name">SUNANTO, S.H</div>
                            </div>
    
                            <ul>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/Kaur Umum.webp" alt="Kaur Tata Usaha" class="profile-img" data-name="ALEK - KAUR TATA USAHA & UMUM">
                                        <span class="badge">KAUR TATA USAHA & UMUM</span>
                                        <div class="name">ALEK</div>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/Kaur keuangan.webp" alt="Kaur Keuangan" class="profile-img" data-name="MERTANIA - KAUR KEUANGAN">
                                        <span class="badge">KAUR KEUANGAN</span>
                                        <div class="name">MERTANIA</div>
                                        <span class="gelar">AMd. AK</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/Kaur perencanaan.webp" alt="Kaur Perencanaan" class="profile-img" data-name="YUNIARTI - KAUR PERENCANAAN">
                                        <span class="badge">KAUR PERENCANAAN</span>
                                        <div class="name">YUNIARTI</div>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
    
    <div id="lightbox" class="lightbox">
        <img id="lightbox-img" class="lightbox-content" src="" alt="View">
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>

</section>

<style>
    /* --- CSS UTAMA --- */
    .organigram-scope {
        --card-width: 220px;
        --line-color: #334b63;
        --line-thick: 3px;
        --gap-vertical: 50px;
        --card-bg: #ffffff;
        --accent-red: #a82525;
        --text-dark: #1e293b;

        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #e3e8ee;
        position: relative;
        overflow: hidden;
        padding: 40px 20px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 80vh; 
    }

    .organigram-scope * { 
        box-sizing: border-box;
    }

    .organigram-wrapper {
        background-color: #ffffff;
        width: max-content;
        min-width: min-content;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 
                    0 0 0 1px rgba(0,0,0,0.03);
        padding: 80px 60px 100px 60px;
        margin: 0;
        position: relative;
        transform-origin: top center;
        transition: transform 0.3s ease-out; 
    }

    .organigram-header {
        text-align: center;
        margin-bottom: 80px;
        color: var(--text-dark);
        text-transform: uppercase;
        letter-spacing: 4px;
        font-weight: 800;
        /* font-size: 1.8rem; <-- DIHAPUS agar bisa diatur via Tailwind class */
        border-bottom: 3px solid #f1f5f9;
        padding-bottom: 25px;
        width: 100%;
    }

    /* --- TREE STRUCTURE --- */
    .tree {
        display: table;
        margin: 0 auto;
    }
    
    .tree ul {
        padding-top: var(--gap-vertical);
        position: relative;
        display: flex;
        justify-content: center;
        padding-left: 0;
    }

    .tree li {
        text-align: center;
        list-style-type: none;
        position: relative;
        padding: var(--gap-vertical) 15px 0 15px; 
    }

    /* --- LOGIKA GARIS (KONEKTOR) --- */
    .tree li::before, .tree li::after {
        content: '';
        position: absolute; top: 0; right: 50%;
        border-top: var(--line-thick) solid var(--line-color); 
        width: 50%; height: var(--gap-vertical); 
        z-index: 0;
    }
    /* Garis vertikal turun (default) */
    .tree li::after {
        right: auto;
        left: 50%;
        border-left: var(--line-thick) solid var(--line-color);
    }
    
    .tree li:only-child::after, .tree li:only-child::before { display: none; }
    .tree li:only-child { padding-top: 0; }
    .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
    
    /* Lengkungan sudut garis */
    .tree li:last-child::before { 
        border-right: var(--line-thick) solid var(--line-color);
        border-radius: 0 16px 0 0; 
    }
    .tree li:first-child::after { 
        border-radius: 16px 0 0 0;
    }
    
    .tree ul ul::before {
        content: '';
        position: absolute; top: 0; left: 50%;
        border-left: var(--line-thick) solid var(--line-color);
        width: 0; height: var(--gap-vertical);
    }

    /* --- PERBAIKAN KHUSUS: GARIS KASI --- */
    .tree ul.level-offset { 
        padding-top: 420px;
    } 
    
    .tree li.branch-long::after {
        height: 480px !important;
        border-left: var(--line-thick) solid var(--line-color);
    }

    /* --- KARTU JABATAN --- */
    .card {
        background: var(--card-bg);
        width: var(--card-width); 
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        border-top: 4px solid var(--line-color);
        border-bottom: 4px solid var(--accent-red); 
        display: inline-block;
        position: relative;
        z-index: 10;
        vertical-align: top;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        border-top-color: var(--accent-red);
    }

    /* --- FOTO & TEXT --- */
    .profile-img {
        width: 100%;
        aspect-ratio: 3/4; object-fit: cover; object-position: top center; 
        border-radius: 8px; margin-bottom: 14px; border: 1px solid #edf2f7; background-color: #f1f5f9;
        display: block;
        cursor: pointer;
    }

    .badge {
        background-color: var(--accent-red); color: white;
        padding: 6px 8px; border-radius: 4px;
        font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 10px;
        text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.2;
    }

    .name { 
        font-size: 0.95rem; font-weight: 700; color: var(--text-dark);
        line-height: 1.4; margin-bottom: 4px; word-wrap: break-word;
    }

    .gelar {
        font-size: 0.8rem;
        color: #64748b; display: block; font-weight: 500; font-style: italic;
    }

    /* --- LIGHTBOX & RESPONSIVE --- */
    .lightbox {
        display: none;
        position: fixed; 
        z-index: 9999;
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(8px);
        display: flex;
        flex-direction: column;
        justify-content: center; 
        align-items: center;
        padding: 20px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-out;
    }

    .lightbox.active { 
        opacity: 1;
        pointer-events: auto;
    }

    .lightbox-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 100%;
    }
    
    .lightbox-content {
        max-height: 65vh;
        max-width: 90%; 
        width: auto;
        border: 4px solid #fff; 
        border-radius: 8px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        object-fit: contain;
    }
    
    .lightbox-caption {
        margin-top: 20px;
        color: #fff; 
        text-align: center; 
        width: 100%; 
        max-width: 800px;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 10px;
    }

    :global(.lb-name) {
        font-family: 'Segoe UI', sans-serif;
        font-weight: 900; 
        color: #ffffff;
        text-shadow: 0 4px 15px rgba(0,0,0,0.9); 
        text-transform: uppercase;
        line-height: 1.2;
        letter-spacing: 1px;
        text-align: center;
    }

    :global(.lb-role) {
        font-weight: 700;
        text-transform: uppercase; 
        letter-spacing: 2px;
        text-align: center;
        margin-top: 5px;
    }

    @media (min-width: 1024px) {
        :global(.lb-name) { font-size: 2.5rem; }
        :global(.lb-role) { 
            font-size: 1.2rem;
            color: #e2e8f0;
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 10px;
        }
    }

    @media (max-width: 1023px) {
        .lightbox-content { max-height: 55vh; } 
        :global(.lb-name) { font-size: 2rem; }
        :global(.lb-role) { 
            font-size: 1rem;
            color: #fca5a5;
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
        }
    }

    @media (max-width: 640px) {
        .lightbox { 
            display: block;
            overflow-y: auto; 
            padding: 0; 
        }
        .lightbox-wrapper {
            min-height: 100%;
            margin: auto;
            padding: 20px 15px;
            justify-content: center;
        }
        .lightbox-content { 
            max-height: 50vh;
            max-width: 100%;
        }
        .lightbox-caption { margin-top: 15px; gap: 5px; }
        :global(.lb-name) { 
            font-size: 1.5rem;
            word-break: break-word;
        }
        :global(.lb-role) { 
            font-size: 0.85rem;
            padding: 6px 12px;
            width: auto;
            border: 1px solid rgba(255,255,255,0.3);
        }
    }

    @media (max-height: 500px) and (orientation: landscape) {
        .lightbox { display: block; overflow-y: auto; }
        .lightbox-wrapper { 
            flex-direction: row;
            min-height: 100%; 
            margin: auto; 
            gap: 20px; 
        }
        .lightbox-content { max-height: 85vh; width: auto; max-width: 45%; }
        .lightbox-caption { align-items: flex-start; text-align: left; }
        :global(.lb-name) { text-align: left; }
    }

    :global(body.no-scroll) { overflow: hidden; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scope = document.querySelector('.organigram-scope') as HTMLElement;
        const wrapper = document.querySelector('.organigram-wrapper') as HTMLElement;
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
        const lightboxCaption = document.getElementById('lightbox-caption');
        const profileImages = document.querySelectorAll('.profile-img');

        function fitOrganigram() {
            if (!scope || !wrapper) return;
            wrapper.style.transform = 'none';
            const contentWidth = wrapper.scrollWidth;
            const containerWidth = scope.clientWidth;
            const paddingHorizontal = 40;
            let scale = (containerWidth - paddingHorizontal) / contentWidth;
            if (scale > 1) scale = 1; 

            wrapper.style.transform = `scale(${scale})`;
            const contentHeight = wrapper.scrollHeight;
            const scaledHeight = contentHeight * scale;
            scope.style.height = `${scaledHeight + 100}px`;
        }

        setTimeout(fitOrganigram, 100);
        window.addEventListener('resize', () => {
             requestAnimationFrame(fitOrganigram);
        });

        profileImages.forEach(img => {
            img.addEventListener('click', function(e) {
                e.stopPropagation(); 
                // @ts-ignore
                const src = this.src;
                // @ts-ignore
                const rawText = this.getAttribute('data-name'); 

                if (lightboxImg) lightboxImg.src = src;
                
                const parts = rawText.split(' - ');
                if (lightboxCaption) {
                    lightboxCaption.innerHTML = `
                        <span class="lb-name">${parts[0]}</span>
                        <span class="lb-role">${parts[1] || ''}</span>
                    `;
                }
                if (lightbox) lightbox.classList.add('active');
                document.body.classList.add('no-scroll');
            });
        });

        if (lightbox) {
            lightbox.addEventListener('click', function() {
                lightbox.classList.remove('active');
                document.body.classList.remove('no-scroll');
            });
        }
    });
</script>