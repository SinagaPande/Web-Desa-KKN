---
// src/components/StrukturOrganisasiSection.astro
---

<section id="pemerintahan-desa" class="organigram-scope">
    
    <div class="organigram-wrapper">
        <div class="organigram-header">Pemerintahan Desa</div>
    
        <div class="tree">
            <ul>
                <li>
                    <div class="card"> 
                        <img src="/Imagery/Aparatur Desa/Kepala Desa.webp" alt="Kepala Desa" class="profile-img" data-name="AGUS SYAHRIWAN - KEPALA DESA">
                        <span class="badge">KEPALA DESA</span>
                        <div class="name">AGUS SYAHRIWAN</div>
                    </div>
    
                    <ul>
                        <li class="branch-long">
                            <ul class="level-offset">
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/KASI PELAYANAN.webp" alt="Kasi Pelayanan" class="profile-img" data-name="HERMAN. S - KASI PELAYANAN">
                                        <span class="badge">KASI PELAYANAN</span>
                                        <div class="name">HERMAN. S</div>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/KASI KESEJAHTERAAN.webp" alt="Kasi Kesejahteraan" class="profile-img" data-name="MUHAMMAD ALWI NASRULLAH - KASI KESEJAHTERAAN">
                                        <span class="badge">KASI KESEJAHTERAAN</span>
                                        <div class="name">MUHAMMAD ALWI NASRULLAH</div>
                                        <span class="gelar">AMd. Kes</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/KASI PEMERINTAHAN.webp" alt="Kasi Pemerintahan" class="profile-img" data-name="MELIANTINA ANDIKA - KASI PEMERINTAHAN">
                                        <span class="badge">KASI PEMERINTAHAN</span>
                                        <div class="name">MELIANTINA ANDIKA</div>
                                    </div>
                                </li>
                            </ul>
                        </li>
    
                        <li>
                            <div class="card">
                                <img src="/Imagery/Aparatur Desa/SEKRETARIS DESA.webp" alt="Sekretaris Desa" class="profile-img" data-name="SUNANTO, S.H - SEKRETARIS DESA">
                                <span class="badge">SEKRETARIS DESA</span>
                                <div class="name">SUNANTO, S.H</div>
                            </div>
    
                            <ul>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/Kaur Umum.webp" alt="Kaur Tata Usaha" class="profile-img" data-name="ALEK - KAUR TATA USAHA & UMUM">
                                        <span class="badge">KAUR TATA USAHA & UMUM</span>
                                        <div class="name">ALEK</div>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/Kaur keuangan.webp" alt="Kaur Keuangan" class="profile-img" data-name="MERTANIA - KAUR KEUANGAN">
                                        <span class="badge">KAUR KEUANGAN</span>
                                        <div class="name">MERTANIA</div>
                                        <span class="gelar">AMd. AK</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="card">
                                        <img src="/Imagery/Aparatur Desa/Kaur perencanaan.webp" alt="Kaur Perencanaan" class="profile-img" data-name="YUNIARTI - KAUR PERENCANAAN">
                                        <span class="badge">KAUR PERENCANAAN</span>
                                        <div class="name">YUNIARTI</div>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
    
    <div id="lightbox" class="lightbox">
        <img id="lightbox-img" class="lightbox-content" src="" alt="View">
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>

</section>

<style>
    /* --- CSS UTAMA --- */
    .organigram-scope {
        --card-width: 220px;
        --line-color: #334b63;
        --line-thick: 3px;
        --gap-vertical: 50px;
        --card-bg: #ffffff;
        --accent-red: #a82525;
        --text-dark: #1e293b;

        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #e3e8ee;
        position: relative;
        padding: 40px;
        overflow: auto; 
        width: 100%;
    }

    .organigram-scope * { 
        box-sizing: border-box; 
    }

    .organigram-wrapper {
        background-color: #ffffff;
        width: max-content;
        min-width: min-content; 
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 
                    0 0 0 1px rgba(0,0,0,0.03); 
        padding: 80px 60px 100px 60px;
        margin: 0 auto; 
        position: relative;
    }

    .organigram-header {
        text-align: center;
        margin-bottom: 80px;
        color: var(--text-dark);
        text-transform: uppercase;
        letter-spacing: 4px;
        font-weight: 800;
        font-size: 1.8rem;
        border-bottom: 3px solid #f1f5f9;
        padding-bottom: 25px;
        width: 100%;
    }

    /* --- TREE STRUCTURE --- */
    .tree {
        display: table;
        margin: 0 auto;
    }
    
    .tree ul {
        padding-top: var(--gap-vertical); 
        position: relative;
        display: flex;
        justify-content: center;
        padding-left: 0;
    }

    .tree li {
        text-align: center;
        list-style-type: none;
        position: relative;
        padding: var(--gap-vertical) 15px 0 15px; 
    }

    /* --- LOGIKA GARIS (KONEKTOR) --- */
    .tree li::before, .tree li::after {
        content: '';
        position: absolute; top: 0; right: 50%;
        border-top: var(--line-thick) solid var(--line-color); 
        width: 50%; height: var(--gap-vertical); 
        z-index: 0;
    }
    /* Garis vertikal turun (default) */
    .tree li::after {
        right: auto; left: 50%;
        border-left: var(--line-thick) solid var(--line-color);
    }
    
    .tree li:only-child::after, .tree li:only-child::before { display: none; }
    .tree li:only-child { padding-top: 0; }
    .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
    
    /* Lengkungan sudut garis */
    .tree li:last-child::before { 
        border-right: var(--line-thick) solid var(--line-color); 
        border-radius: 0 16px 0 0; 
    }
    .tree li:first-child::after { 
        border-radius: 16px 0 0 0; 
    }
    
    .tree ul ul::before {
        content: '';
        position: absolute; top: 0; left: 50%;
        border-left: var(--line-thick) solid var(--line-color);
        width: 0; height: var(--gap-vertical); 
    }

    /* --- PERBAIKAN KHUSUS: GARIS KASI --- */
    /* Kita turunkan isi ul sejauh 430px */
    .tree ul.level-offset { 
        padding-top: 430px; 
    } 
    
    /* Kita panjangkan garis vertikal pada induknya (li) agar nyambung ke bawah */
    .tree li.branch-long::after {
        height: 480px !important; /* Memaksa garis menjadi panjang */
        border-left: var(--line-thick) solid var(--line-color);
    }

    /* --- KARTU JABATAN --- */
    .card {
        background: var(--card-bg);
        width: var(--card-width); 
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        border-top: 4px solid var(--line-color); 
        border-bottom: 4px solid var(--accent-red); 
        display: inline-block;
        position: relative;
        z-index: 10;
        vertical-align: top;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        border-top-color: var(--accent-red);
    }

    /* --- FOTO & TEXT --- */
    .profile-img {
        width: 100%; aspect-ratio: 3/4; object-fit: cover; object-position: top center; 
        border-radius: 8px; margin-bottom: 14px; border: 1px solid #edf2f7; background-color: #f1f5f9;
        display: block; cursor: pointer;
    }

    .badge {
        background-color: var(--accent-red); color: white; padding: 6px 8px; border-radius: 4px;
        font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 10px;
        text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.2;
    }

    .name { 
        font-size: 0.95rem; font-weight: 700; color: var(--text-dark);
        line-height: 1.4; margin-bottom: 4px; word-wrap: break-word;
    }

    .gelar {
        font-size: 0.8rem; color: #64748b; display: block; font-weight: 500; font-style: italic;
    }

    /* --- LIGHTBOX & RESPONSIVE --- */
    .lightbox {
        display: none; position: fixed; z-index: 9999;
        left: 0; top: 0; width: 100%; height: 100%; 
        background-color: rgba(30, 41, 59, 0.95);
        justify-content: center; align-items: center; flex-direction: column;
        backdrop-filter: blur(8px); padding: 20px;
    }
    .lightbox.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    .lightbox-content {
        max-width: 90%; max-height: 80vh; 
        border: 4px solid #fff; border-radius: 8px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    .lightbox-caption {
        margin-top: 30px; color: #fff; text-align: center; width: 100%; padding: 0 20px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        gap: 25px; cursor: pointer; 
    }

    @media (max-width: 768px) {
        .lightbox-content { max-width: 95vw; max-height: 60vh; }
    }

    :global(.lb-name) {
        font-size: 3rem; font-weight: 900; line-height: 1.1; color: #ffffff;
        text-shadow: 0 4px 15px rgba(0,0,0,0.9); text-transform: uppercase;
        font-family: 'Segoe UI', sans-serif; margin-bottom: 10px; letter-spacing: 1px;
    }

    :global(.lb-role) {
        font-size: 1.4rem; font-weight: 700; color: #fca5a5;
        text-transform: uppercase; letter-spacing: 3px;
        background-color: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 12px 24px; border-radius: 50px; width: 90%; max-width: 500px;
    }

    @media (max-width: 400px) {
        .lightbox-content { max-width: 98vw; max-height: 55vh; }
        :global(.lb-name) { font-size: 2.5rem; }
        :global(.lb-role) { font-size: 1.3rem; padding: 10px 20px; width: 95%; }
    }

    @media (min-width: 768px) {
        .lightbox-content { max-width: 90%; max-height: 80vh; }
        .lightbox-caption { gap: 10px; }
        :global(.lb-name) { font-size: 2.5rem; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        :global(.lb-role) { 
            font-size: 1.3rem; letter-spacing: 3px; background: transparent; border: none;
            border-top: 2px solid rgba(255, 255, 255, 0.5); border-radius: 0; padding: 15px 0 0 0;
            width: auto; max-width: none; color: rgba(255, 255, 255, 0.9);
        }
    }

    :global(body.no-scroll) { overflow: hidden; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const wrapper = document.querySelector('.organigram-wrapper');
        const rootCard = document.querySelector('.tree > ul > li > .card');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const profileImages = document.querySelectorAll('.profile-img');

        let lastWidth = window.innerWidth;
        let isUserInteracting = false; 

        // Lightbox Logic
        profileImages.forEach(img => {
            img.addEventListener('click', function(e) {
                e.stopPropagation(); 
                // @ts-ignore
                lightboxImg.src = this.src;
                // @ts-ignore
                const rawText = this.getAttribute('data-name'); 
                const parts = rawText.split(' - '); 
                
                if (lightboxCaption) {
                    lightboxCaption.innerHTML = `
                        <span class="lb-name">${parts[0]}</span>
                        <span class="lb-role">${parts[1] || ''}</span>
                    `;
                }
                if (lightbox) lightbox.classList.add('active');
                document.body.classList.add('no-scroll');
            });
        });

        if (lightbox) {
            lightbox.addEventListener('click', function() {
                lightbox.classList.remove('active');
                document.body.classList.remove('no-scroll');
            });
        }

        // Auto Center Logic
        function centerOrganigram(force = false) {
            if (!wrapper || !rootCard) return;
            // @ts-ignore
            if (lightbox && lightbox.classList.contains('active')) return;
            if (isUserInteracting && !force) return; 

            const cardRect = rootCard.getBoundingClientRect();
            const currentScrollX = window.scrollX || document.documentElement.scrollLeft;
            const absoluteCardCenterX = currentScrollX + cardRect.left + (cardRect.width / 2);
            const viewportWidth = window.innerWidth;
            const scrollToX = absoluteCardCenterX - (viewportWidth / 2);

            window.scrollTo({ left: scrollToX, behavior: force ? 'auto' : 'smooth' });
        }

        setTimeout(() => { centerOrganigram(true); }, 100);
        window.addEventListener('touchstart', () => { isUserInteracting = true; });
        window.addEventListener('wheel', () => { isUserInteracting = true; });
        window.addEventListener('resize', () => {
            if (window.innerWidth !== lastWidth) {
                lastWidth = window.innerWidth;
                isUserInteracting = false; 
                centerOrganigram(true);
            }
        });
    });
</script>